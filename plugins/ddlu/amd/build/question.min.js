/*
 * JavaScript to allow dragging options to slots (using mouse down or touch) or tab through slots using keyboard.
 *
 * @module     qtype_ddlu/question
 * @copyright  2018 The Open University
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/dragdrop","core/key_codes"],function(e,t,o){"use strict";function a(e,t,o){this.containerId=e,M.util.js_pending("qtype_ddlu-init-"+this.containerId),this.places=o,this.allImagesLoaded=!1,this.imageLoadingTimeoutId=null,this.isPrinting=!1,t&&this.getRoot().addClass("qtype_ddlu-readonly");var a=this;this.getNotYetLoadedImages().one("load",function(){a.waitForAllImagesToBeLoaded()}),this.waitForAllImagesToBeLoaded()}a.prototype.waitForAllImagesToBeLoaded=function(){var e=this;this.allImagesLoaded||(null!==this.imageLoadingTimeoutId&&clearTimeout(this.imageLoadingTimeoutId),this.getNotYetLoadedImages().length>0?this.imageLoadingTimeoutId=setTimeout(function(){e.waitForAllImagesToBeLoaded()},100):(this.allImagesLoaded=!0,e.setupQuestion()))},a.prototype.getNotYetLoadedImages=function(){var e=this;return this.getRoot().find(".ddarea img").not(function(t,o){return e.imageIsLoaded(o)})},a.prototype.imageIsLoaded=function(e){return e.complete&&0!==e.naturalHeight},a.prototype.setupQuestion=function(){this.resizeAllDragsAndDrops(),this.cloneDrags(),this.positionDragsAndDrops(),M.util.js_complete("qtype_ddlu-init-"+this.containerId)},a.prototype.resizeAllDragsAndDrops=function(){var t=this;this.getRoot().find(".draghomes > div").each(function(o,a){t.resizeAllDragsAndDropsInGroup(t.getClassnameNumericSuffix(e(a),"dragitemgroup"))})},a.prototype.resizeAllDragsAndDropsInGroup=function(t){var o=this.getRoot(),a=o.find(".dragitemgroup"+t+" .draghome"),n=0,i=0;for(var r in a.each(function(e,t){n=Math.max(n,Math.ceil(t.offsetWidth)),i=Math.max(i,Math.ceil(t.offsetHeight))}),n+=10,i+=10,a.each(function(t,o){var a=Math.round((n-o.offsetWidth)/2),r=Math.floor((i-o.offsetHeight)/2);e(o).css({"padding-left":a+"px","padding-right":n-o.offsetWidth-a+"px","padding-top":r+"px","padding-bottom":i-o.offsetHeight-r+"px"})}),this.places)if(this.places.hasOwnProperty(r)){var s=this.places[r],d=s.text;parseInt(s.group)===t&&(""===d&&(d=M.util.get_string("blank","qtype_ddlu")),o.find(".dropzones").append('<div class="dropzone active group'+s.group+" place"+r+'" tabindex="0"><span class="accesshide">'+d+"</span>&nbsp;</div>"),o.find(".dropzone.place"+r).width(n-2).height(i-2))}},a.prototype.cloneDrags=function(){var t=this;t.getRoot().find(".draghome").each(function(o,a){var n=e(a),i=n.clone();i.removeClass(),i.addClass("draghome choice"+t.getChoice(n)+" group"+t.getGroup(n)+" dragplaceholder"),n.before(i)})},a.prototype.cloneDragsForOneChoice=function(e){this.cloneDrag(e)},a.prototype.cloneDrag=function(e){var t=e.clone();t.removeClass("draghome").addClass("drag unplaced moodle-has-zindex").offset(e.offset()),this.getRoot().find(".dragitems").append(t)},a.prototype.positionDragsAndDrops=function(){var t=this,o=this.getRoot(),a=this.bgRatio();o.find(".ddarea .dropzone").each(function(o,n){var i=e(n),r=t.places[t.getPlace(i)];i.css("left",parseInt(r.xy[0])*a).css("top",parseInt(r.xy[1])*a),i.data("originX",parseInt(r.xy[0])).data("originY",parseInt(r.xy[1])),t.handleElementScale(i,"left top")}),o.find(".draghome").not(".dragplaceholder").each(function(o,a){var n=e(a),i=t.getClassnameNumericSuffix(n,"inplace");n.addClass("unplaced").removeClass("placed"),n.removeAttr("tabindex"),null!==i&&n.removeClass("inplace"+i)}),o.find("input.placeinput").each(function(a,n){var i=e(n),r=i.val();if(!(0===r.length||r.length>0&&"0"===r)){var s=t.getPlace(i),d=t.getUnplacedChoice(t.getGroup(i),r),g=t.getDragClone(d);g.length&&g.addClass("active");var l=o.find(".dropzone.place"+s);t.sendDragToDrop(d,l)}})},a.prototype.handleDragStart=function(o){var a=this,n=e(o.target).closest(".draghome"),i=this.calculateZIndex()+2;if(t.prepare(o).start&&!n.hasClass("beingdragged")){n.addClass("beingdragged").css("transform","").css("z-index",i);var r=this.getClassnameNumericSuffix(n,"inplace");if(null!==r){this.setInputValue(r,0),n.removeClass("inplace"+r);var s=a.getDrop(n,r);s.length&&(s.addClass("active"),n.offset(s.offset()))}else{var d=a.getDragClone(n);d.length&&(d.addClass("active"),n.offset(d.offset()))}t.start(o,n,function(e,t,o){a.dragMove(e,t,o)},function(e,t,o){a.dragEnd(e,t,o)})}},a.prototype.dragMove=function(t,o,a){var n=this,i=!1;this.getRoot().find(".dropzone.group"+this.getGroup(a)).each(function(a,r){var s=e(r);n.isPointInDrop(t,o,s)&&!i?(i=!0,s.addClass("valid-drag-over-drop")):s.removeClass("valid-drag-over-drop")}),this.getRoot().find(".draghome.placed.group"+this.getGroup(a)).not(".beingdragged").each(function(r,s){var d=e(s);!n.isPointInDrop(t,o,d)||i||n.isDragSameAsDrop(a,d)?d.removeClass("valid-drag-over-drop"):(i=!0,d.addClass("valid-drag-over-drop"))})},a.prototype.dragEnd=function(t,o,a){var n=this,i=this.getRoot(),r=!1;i.find(".dropzone.group"+this.getGroup(a)).each(function(i,s){var d=e(s);return!n.isPointInDrop(t,o,d)||(d.removeClass("valid-drag-over-drop"),n.sendDragToDrop(a,d),r=!0,!1)}),r||i.find(".draghome.placed.group"+this.getGroup(a)).not(".beingdragged").each(function(i,s){var d=e(s);if(!n.isPointInDrop(t,o,d)||n.isDragSameAsDrop(a,d))return!0;d.removeClass("valid-drag-over-drop");var g=n.getClassnameNumericSuffix(d,"inplace"),l=n.getDrop(a,g);return n.sendDragToDrop(a,l),r=!0,!1}),r||this.sendDragHome(a)},a.prototype.sendDragToDrop=function(e,t){var o=this.getCurrentDragInPlace(this.getPlace(t));if(0!==o.length){o.addClass("beingdragged"),o.offset(o.offset());var a=this.getClassnameNumericSuffix(o,"inplace");this.getDrop(o,a).addClass("active"),this.sendDragHome(o)}if(0===e.length)this.setInputValue(this.getPlace(t),0),t.data("isfocus")&&t.focus();else{this.setInputValue(this.getPlace(t),this.getChoice(e)),e.removeClass("unplaced").addClass("placed inplace"+this.getPlace(t));var n=e.attr("class");document.getElementsByClassName(n)[0].setAttribute("hidden",!0);var i=document.getElementById("countDrop").innerHTML;document.getElementById("countDrop").innerHTML=parseInt(i)+parseInt(1),e.attr("tabindex",0),this.animateTo(e,t)}},a.prototype.sendDragHome=function(e){var t=this.getClassnameNumericSuffix(e,"inplace");null!==t&&e.removeClass("inplace"+t),e.data("unplaced",!0),this.animateTo(e,this.getDragHome(this.getGroup(e),this.getChoice(e)))},a.prototype.handleKeyPress=function(t){var a=e(t.target).closest(".dropzone");if(0===a.length){var i=e(t.target),r=this.getClassnameNumericSuffix(i,"inplace");null!==r&&(a=this.getDrop(i,r))}var s=this.getCurrentDragInPlace(this.getPlace(a)),d=e();switch(t.keyCode){case o.space:case o.arrowRight:case o.arrowDown:d=this.getNextDrag(this.getGroup(a),s);break;case o.arrowLeft:case o.arrowUp:d=this.getPreviousDrag(this.getGroup(a),s);break;case o.escape:n.isKeyboardNavigation=!1;break;default:return void(n.isKeyboardNavigation=!1)}if(d.length){d.data("isfocus",!0),d.addClass("beingdragged");var g=this.getDragClone(d);g.length&&(g.addClass("active"),d.offset(g.offset()))}else a.data("isfocus",!0);t.preventDefault(),this.sendDragToDrop(d,a)},a.prototype.getNextDrag=function(e,t){var o,a=this.noOfChoicesInGroup(e);o=0===t.length?1:this.getChoice(t)+1;for(var n=this.getUnplacedChoice(e,o);0===n.length&&o<a;)o++,n=this.getUnplacedChoice(e,o);return n},a.prototype.getPreviousDrag=function(e,t){var o;o=0===t.length?this.noOfChoicesInGroup(e):this.getChoice(t)-1;for(var a=this.getUnplacedChoice(e,o);0===a.length&&o>1;)o--,a=this.getUnplacedChoice(e,o);return a},a.prototype.animateTo=function(t,o){var a=t.offset(),n=o.offset(),i=this;M.util.js_pending("qtype_ddlu-animate-"+i.containerId),t.animate({left:parseInt(t.css("left"))+n.left-a.left,top:parseInt(t.css("top"))+n.top-a.top},{duration:"fast",done:function(){e("body").trigger("qtype_ddlu-dragmoved",[t,o,i]),M.util.js_complete("qtype_ddlu-animate-"+i.containerId)}})},a.prototype.isPointInDrop=function(e,t,o){var a=o.offset();return o.hasClass("draghome")?e>=a.left&&e<a.left+o.outerWidth()&&t>=a.top&&t<a.top+o.outerHeight():e>=a.left&&e<a.left+o.width()&&t>=a.top&&t<a.top+o.height()},a.prototype.setInputValue=function(e,t){this.getRoot().find("input.placeinput.place"+e).val(t)},a.prototype.getRoot=function(){return e(document.getElementById(this.containerId))},a.prototype.bgImage=function(){return this.getRoot().find("img.dropbackground")},a.prototype.getDragHome=function(e,t){return this.getRoot().find(".draghome.dragplaceholder.group"+e+".choice"+t).is(":visible")?this.getRoot().find(".draghome.dragplaceholder.group"+e+".choice"+t):this.getRoot().find(".dragitemgroup"+e+".choice"+t+".group"+e)},a.prototype.getUnplacedChoice=function(e,t){return this.getRoot().find(".ddarea .draghome.group"+e+".choice"+t+".unplaced").slice(0,1)},a.prototype.getCurrentDragInPlace=function(e){return this.getRoot().find(".ddarea .draghome.inplace"+e)},a.prototype.noOfDropsInGroup=function(e){return this.getRoot().find(".dropzone.group"+e).length},a.prototype.noOfChoicesInGroup=function(e){return this.getRoot().find(".dragitemgroup"+e+" .draghome").length},a.prototype.getClassnameNumericSuffix=function(e,t){var o=e.attr("class");if(""!==o)for(var a=o.split(" "),n=0;n<a.length;n++){if(new RegExp("^"+t+"([0-9])+$").test(a[n])){var i=new RegExp("([0-9])+$").exec(a[n]);return Number(i[0])}}return null},a.prototype.getChoice=function(e){return this.getClassnameNumericSuffix(e,"choice")},a.prototype.getGroup=function(e){return this.getClassnameNumericSuffix(e,"group")},a.prototype.getPlace=function(e){return this.getClassnameNumericSuffix(e,"place")},a.prototype.getDragClone=function(e){return this.getRoot().find(".dragitemgroup"+this.getGroup(e)+" .draghome.choice"+this.getChoice(e)+".group"+this.getGroup(e)+".dragplaceholder")},a.prototype.getDrop=function(e,t){return this.getRoot().find(".dropzone.group"+this.getGroup(e)+".place"+t)},a.prototype.handleResize=function(){var t=this,o=this.bgRatio();this.isPrinting&&(o=1),this.getRoot().find(".ddarea .dropzone").each(function(a,n){e(n).css("left",parseInt(e(n).data("originX"))*parseFloat(o)).css("top",parseInt(e(n).data("originY"))*parseFloat(o)),t.handleElementScale(n,"left top")}),this.getRoot().find("div.droparea .draghome").not(".beingdragged").each(function(a,n){e(n).css("left",parseFloat(e(n).data("originX"))*parseFloat(o)).css("top",parseFloat(e(n).data("originY"))*parseFloat(o)),t.handleElementScale(n,"left top")})},a.prototype.bgRatio=function(){var e=this.bgImage(),t=e.get(0).naturalWidth;return e.width()/t},a.prototype.handleElementScale=function(t,o){var a=parseFloat(this.bgRatio());this.isPrinting&&(a=1),e(t).css({"-webkit-transform":"scale("+a+")","-moz-transform":"scale("+a+")","-ms-transform":"scale("+a+")","-o-transform":"scale("+a+")",transform:"scale("+a+")","transform-origin":o})},a.prototype.calculateZIndex=function(){var t=0;return this.getRoot().find(".ddarea .dropzone, div.droparea .draghome").each(function(o,a){var n=(a=e(a)).css("z-index")?parseInt(a.css("z-index")):0;n>t&&(t=n)}),t},a.prototype.isDragSameAsDrop=function(e,t){return this.getChoice(e)===this.getChoice(t)&&this.getGroup(e)===this.getGroup(t)};var n={eventHandlersInitialised:!1,dragEventHandlersInitialised:{},isPrinting:!1,isKeyboardNavigation:!1,questions:{},init:function(t,o,i){if(n.questions[t]=new a(t,o,i),n.eventHandlersInitialised||(n.setupEventHandlers(),n.eventHandlersInitialised=!0),!n.dragEventHandlersInitialised.hasOwnProperty(t)){n.dragEventHandlersInitialised[t]=!0;var r=document.getElementById(t);r.classList.contains("ddlu")&&!r.classList.contains("qtype_ddlu-readonly")&&n.addEventHandlersToDrag(e(r).find(".draghome"))}},setupEventHandlers:function(){e("body").on("keydown",".que.ddlu:not(.qtype_ddlu-readonly) .dropzones .dropzone",n.handleKeyPress).on("keydown",".que.ddlu:not(.qtype_ddlu-readonly) .draghome.placed:not(.beingdragged)",n.handleKeyPress).on("qtype_ddlu-dragmoved",n.handleDragMoved),e(window).on("resize",function(){n.handleWindowResize(!1)}),window.addEventListener("beforeprint",function(){n.isPrinting=!0,n.handleWindowResize(n.isPrinting)}),window.addEventListener("afterprint",function(){n.isPrinting=!1,n.handleWindowResize(n.isPrinting)}),setTimeout(function(){n.fixLayoutIfThingsMoved()},100)},addEventHandlersToDrag:function(e){e.unbind("mousedown touchstart"),e.on("mousedown touchstart",n.handleDragStart)},handleDragStart:function(e){e.preventDefault();var t=n.getQuestionForEvent(e);t&&t.handleDragStart(e)},handleKeyPress:function(e){if(!n.isKeyboardNavigation){n.isKeyboardNavigation=!0;var t=n.getQuestionForEvent(e);t&&t.handleKeyPress(e)}},handleWindowResize:function(e){for(var t in n.questions)n.questions.hasOwnProperty(t)&&(n.questions[t].isPrinting=e,n.questions[t].handleResize())},fixLayoutIfThingsMoved:function(){this.handleWindowResize(n.isPrinting),setTimeout(function(){n.fixLayoutIfThingsMoved(n.isPrinting)},100)},handleDragMoved:function(e,t,o,a){t.removeClass("beingdragged").css("z-index",""),t.css("top",o.position().top).css("left",o.position().left),o.after(t),o.removeClass("active"),void 0!==t.data("unplaced")&&!0===t.data("unplaced")?(t.removeClass("placed").addClass("unplaced"),t.removeAttr("tabindex"),t.removeData("unplaced"),t.css("top","").css("left","").css("transform","")):(t.data("originX",o.data("originX")).data("originY",o.data("originY")),a.handleElementScale(t,"left top")),void 0!==t.data("isfocus")&&!0===t.data("isfocus")&&(t.focus(),t.removeData("isfocus")),void 0!==o.data("isfocus")&&!0===o.data("isfocus")&&o.removeData("isfocus"),n.isKeyboardNavigation&&(n.isKeyboardNavigation=!1)},getQuestionForEvent:function(t){var o=e(t.currentTarget).closest(".que.ddlu").attr("id");return n.questions[o]}};return{init:n.init}});
//# sourceMappingURL=question.min.js.map